name: Build and Cache EDA Tools

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:
    inputs:
      packages:
        description: 'Packages to build (comma-separated, or "all")'
        required: false
        default: "all"
  schedule:
    # Rebuild weekly to stay current with nixpkgs
    - cron: "0 6 * * 0"

env:
  CACHIX_CACHE: uwasic-eda

jobs:
  build-packages:
    name: Build ${{ matrix.package }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        package:
          - ngspice-shared
          - netgen
          - xschem
          - klayout

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main
        with:
          extra-conf: |
            experimental-features = nix-command flakes
            accept-flake-config = true

      - name: Setup Cachix
        uses: cachix/cachix-action@v14
        with:
          name: ${{ env.CACHIX_CACHE }}
          authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"
          # Push built packages to cache
          pushFilter: '(-source$|\.tar\.gz$|\.patch$)'

      - name: Build ${{ matrix.package }}
        run: |
          echo "ðŸ”¨ Building ${{ matrix.package }}..."
          nix build .#${{ matrix.package }} --print-build-logs

      - name: Show build output
        run: |
          echo "âœ… Successfully built ${{ matrix.package }}"
          nix path-info .#${{ matrix.package }} --human-readable --recursive | head -20

  test-packages:
    name: Test All Packages
    runs-on: ubuntu-latest
    needs: build-packages

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main
        with:
          extra-conf: |
            experimental-features = nix-command flakes
            accept-flake-config = true

      - name: Setup Cachix
        uses: cachix/cachix-action@v14
        with:
          name: ${{ env.CACHIX_CACHE }}
          authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"

      - name: Run package tests
        run: |
          echo "ðŸ§ª Running package tests..."
          nix-build test.nix -A all

      - name: Show test results
        run: |
          echo "âœ… All tests passed!"
          cat result/test-results.txt

  summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [build-packages, test-packages]
    if: always()

    steps:
      - name: Generate Summary
        run: |
          echo "## ðŸ“¦ UWASIC EDA Tools - Cachix Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Cache:** \`${{ env.CACHIX_CACHE }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### ðŸ“š Packages Built" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Package | Description |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------------|" >> $GITHUB_STEP_SUMMARY
          echo "| ngspice-shared | NGSPICE with shared library support |" >> $GITHUB_STEP_SUMMARY
          echo "| netgen | LVS netlist comparison tool |" >> $GITHUB_STEP_SUMMARY
          echo "| xschem | Schematic capture and netlisting |" >> $GITHUB_STEP_SUMMARY
          echo "| klayout | Layout viewer and editor |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### ðŸš€ Usage" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Install Packages Directly" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# Configure Cachix" >> $GITHUB_STEP_SUMMARY
          echo "cachix use ${{ env.CACHIX_CACHE }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Install a specific package" >> $GITHUB_STEP_SUMMARY
          echo "nix profile install github:UWASIC/uwasic-eda-packages#xschem" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Or run directly without installing" >> $GITHUB_STEP_SUMMARY
          echo "nix run github:UWASIC/uwasic-eda-packages#xschem" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "#### Build All Packages" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# Build the default (all packages)" >> $GITHUB_STEP_SUMMARY
          echo "nix build github:UWASIC/uwasic-eda-packages" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### âœ… Features" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- âœ“ All packages cached on Cachix" >> $GITHUB_STEP_SUMMARY
          echo "- âœ“ Modular package structure" >> $GITHUB_STEP_SUMMARY
          echo "- âœ“ Automated testing" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
