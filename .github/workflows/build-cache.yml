name: Build and Cache EDA Tools

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:
    inputs:
      packages:
        description: 'Packages to build (comma-separated, or "all")'
        required: false
        default: 'all'
  schedule:
    # Rebuild weekly to stay current with nixpkgs
    - cron: '0 6 * * 0'

env:
  # Change this to your Cachix cache name
  CACHIX_CACHE: uwasic-eda

jobs:
  build:
    name: Build EDA Packages
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        package:
          - openroad
          - magic-vlsi
          - yosys
          - cocotb
          - verilator
          - klayout
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main
        with:
          extra-conf: |
            experimental-features = nix-command flakes
            accept-flake-config = true

      - name: Setup Cachix
        uses: cachix/cachix-action@v14
        with:
          name: ${{ env.CACHIX_CACHE }}
          authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'
          # Push built packages to cache
          pushFilter: '(-source$|\.tar\.gz$|\.patch$)'

      - name: Build ${{ matrix.package }}
        run: |
          echo "ðŸ”¨ Building ${{ matrix.package }}..."
          nix build .#${{ matrix.package }} --print-build-logs
          
      - name: Show build output
        run: |
          echo "âœ… Successfully built ${{ matrix.package }}"
          nix path-info .#${{ matrix.package }} --human-readable

  build-shell:
    name: Build Development Shell
    runs-on: ubuntu-latest
    needs: build
    if: always()
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main
        with:
          extra-conf: |
            experimental-features = nix-command flakes
            accept-flake-config = true

      - name: Setup Cachix
        uses: cachix/cachix-action@v14
        with:
          name: ${{ env.CACHIX_CACHE }}
          authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'

      - name: Build development shell
        run: |
          echo "ðŸš Building development shell..."
          nix build .#devShells.x86_64-linux.default --print-build-logs

      - name: Test shell environment
        run: |
          echo "ðŸ§ª Testing shell environment..."
          nix develop --command bash -c "echo 'Shell works! Available: yosys, openroad, magic, verilator, klayout, cocotb'"

  summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [build, build-shell]
    if: always()
    
    steps:
      - name: Summary
        run: |
          echo "## ðŸ“¦ Cachix Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Cache: \`${{ env.CACHIX_CACHE }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Packages Built" >> $GITHUB_STEP_SUMMARY
          echo "- openroad" >> $GITHUB_STEP_SUMMARY
          echo "- magic-vlsi" >> $GITHUB_STEP_SUMMARY
          echo "- yosys" >> $GITHUB_STEP_SUMMARY
          echo "- cocotb" >> $GITHUB_STEP_SUMMARY
          echo "- verilator" >> $GITHUB_STEP_SUMMARY
          echo "- klayout" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Usage" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "cachix use ${{ env.CACHIX_CACHE }}" >> $GITHUB_STEP_SUMMARY
          echo "nix develop github:UWASIC/NixPackage" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
